---
import Layout from '../layouts/Layout.astro';
---

<Layout title="–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞">
	<div class="min-h-screen bg-white">
		<!-- Header -->
		<header class="bg-orange-600 text-white px-4 py-6">
			<div class="max-w-md mx-auto">
				<div class="flex items-center justify-between mb-4">
					<button id="backBtn" class="text-orange-200 hover:text-white">‚Üê –ù–∞–∑–∞–¥</button>
					<h1 class="text-xl font-bold">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</h1>
					<div class="w-16"></div> <!-- Spacer -->
				</div>
			</div>
		</header>

		<!-- Main Content -->
		<main class="max-w-md mx-auto px-4 py-6">
			<!-- Original Order Info -->
			<div id="originalOrderInfo" class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
				<h2 class="text-lg font-semibold text-gray-900 mb-3">üìã –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–∫–∞–∑</h2>
				<div id="originalOrderDetails" class="space-y-2">
					<!-- Original order details will be populated by JavaScript -->
				</div>
			</div>

			<!-- Added Items -->
			<div id="addedItemsInfo" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
				<h2 class="text-lg font-semibold text-blue-900 mb-3">‚ûï –î–æ–±–∞–≤–ª—è–µ–º—ã–µ —Ç–æ–≤–∞—Ä—ã</h2>
				<div id="addedItemsDetails" class="space-y-2">
					<!-- Added items will be populated by JavaScript -->
				</div>
			</div>

			<!-- Modification Note -->
			<div id="modificationNoteSection" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
				<h3 class="text-md font-medium text-yellow-900 mb-2">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</h3>
				<p id="modificationNoteText" class="text-sm text-yellow-800"></p>
			</div>

			<!-- WhatsApp Message Preview -->
			<div class="bg-white border border-gray-200 rounded-lg p-4 mb-6">
				<h3 class="text-md font-medium text-gray-900 mb-3">–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è WhatsApp</h3>
				<div class="bg-gray-50 border border-gray-200 rounded p-3 text-sm font-mono">
					<pre id="whatsappMessage" class="whitespace-pre-wrap text-gray-800"></pre>
				</div>
			</div>

			<!-- Info Notice -->
			<div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
				<div class="flex items-start space-x-2">
					<span class="text-blue-600 mt-0.5">‚ÑπÔ∏è</span>
					<div class="text-sm text-blue-800">
						<p class="font-medium mb-1">–ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è:</p>
						<p>‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑</p>
						<p>‚Ä¢ –ò—Å—Ö–æ–¥–Ω—ã–π –∑–∞–∫–∞–∑ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π</p>
						<p>‚Ä¢ –ö—É—Ä—å–µ—Ä —É–≤–∏–¥–∏—Ç –æ–±–∞ –∑–∞–∫–∞–∑–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –¥–æ—Å—Ç–∞–≤–∫–∏</p>
					</div>
				</div>
			</div>

			<!-- Action Buttons -->
			<div class="space-y-3">
				<!-- Copy to Clipboard Button -->
				<button 
					id="copyBtn" 
					class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-4 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2"
				>
					<span>üìã</span>
					<span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
				</button>

				<!-- Send to WhatsApp Button -->
				<button 
					id="sendWhatsAppBtn" 
					class="w-full bg-green-500 hover:bg-green-700 text-white font-medium py-4 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2"
				>
					<span>üì±</span>
					<span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp</span>
				</button>

				<!-- Go to Delivery Page Button -->
				<button 
					id="deliveryPageBtn" 
					class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-4 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center space-x-2"
				>
					<span>üöö</span>
					<span>–ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–æ—Å—Ç–∞–≤–∫–µ</span>
				</button>

				<!-- Cancel Button -->
				<button 
					id="cancelBtn" 
					class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-6 rounded-lg transition-colors duration-200"
				>
					–û—Ç–º–µ–Ω–∏—Ç—å
				</button>
			</div>

			<!-- Success Message -->
			<div id="successMessage" class="hidden mt-4 p-4 bg-green-100 border border-green-300 rounded-lg">
				<div class="flex items-center">
					<span class="text-green-600 mr-2">‚úÖ</span>
					<span class="text-green-800 font-medium">–°–æ–æ–±—â–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!</span>
				</div>
			</div>
		</main>
	</div>

	<script is:inline>
		let modificationData = null;

		// Initialize the page
		document.addEventListener('DOMContentLoaded', function() {
			loadModificationData();
			setupEventListeners();
		});

		function loadModificationData() {
			try {
				// Get modification data from localStorage
				const storedData = localStorage.getItem('pendingModification');
				if (!storedData) {
					throw new Error('–î–∞–Ω–Ω—ã–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
				}

				modificationData = JSON.parse(storedData);
				console.log('üìã Loaded modification data:', modificationData);

				displayModificationDetails();
			} catch (error) {
				console.error('‚ùå Failed to load modification data:', error);
				alert(`–û—à–∏–±–∫–∞: ${error.message}`);
				window.history.back();
			}
		}

		function displayModificationDetails() {
			if (!modificationData) return;

			// Display original order info
			displayOriginalOrder();
			
			// Display added items
			displayAddedItems();
			
			// Display modification note
			displayModificationNote();
			
			// Generate and display WhatsApp message
			generateWhatsAppMessage();
		}

		function displayOriginalOrder() {
			const container = document.getElementById('originalOrderDetails');
			const originalOrder = modificationData.originalOrder;
			
			if (!originalOrder) {
				container.innerHTML = '<p class="text-gray-600">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏—Å—Ö–æ–¥–Ω–æ–º –∑–∞–∫–∞–∑–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>';
				return;
			}

			const orderDate = new Date(originalOrder.timestamp).toLocaleString('ru-RU');
			
			let html = `
				<div class="flex justify-between items-center border-b border-gray-200 pb-2 mb-2">
					<span class="font-medium">${originalOrder.departmentName}</span>
					<span class="text-sm text-gray-600">${orderDate}</span>
				</div>
			`;

			if (originalOrder.items && originalOrder.items.length > 0) {
				originalOrder.items.forEach(item => {
					html += `
						<div class="flex justify-between items-center text-sm">
							<span>${item.name}</span>
							<span class="font-medium">${item.quantity} ${item.unit}</span>
						</div>
					`;
				});
			}

			html += `
				<div class="border-t border-gray-200 pt-2 mt-2">
					<div class="flex justify-between items-center text-sm font-medium">
						<span>–í—Å–µ–≥–æ –ø–æ–∑–∏—Ü–∏–π:</span>
						<span>${originalOrder.totalItems || originalOrder.items?.length || 0}</span>
					</div>
				</div>
			`;

			container.innerHTML = html;
		}

		function displayAddedItems() {
			const container = document.getElementById('addedItemsDetails');
			const addedItems = modificationData.modificationOrder?.items || [];
			
			if (addedItems.length === 0) {
				container.innerHTML = '<p class="text-gray-600">–ù–µ—Ç –¥–æ–±–∞–≤–ª—è–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</p>';
				return;
			}

			let html = `
				<div class="flex justify-between items-center border-b border-blue-200 pb-2 mb-2">
					<span class="font-medium text-blue-900">${modificationData.modificationOrder.departmentName}</span>
					<span class="text-sm text-blue-700">–î–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</span>
				</div>
			`;

			addedItems.forEach(item => {
				html += `
					<div class="flex justify-between items-center text-sm">
						<span>${item.name}</span>
						<span class="font-medium text-blue-700">${item.quantity} ${item.unit}</span>
					</div>
				`;
			});

			html += `
				<div class="border-t border-blue-200 pt-2 mt-2">
					<div class="flex justify-between items-center text-sm font-medium text-blue-900">
						<span>–î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ–∑–∏—Ü–∏–π:</span>
						<span>${addedItems.length}</span>
					</div>
				</div>
			`;

			container.innerHTML = html;
		}

		function displayModificationNote() {
			const noteText = document.getElementById('modificationNoteText');
			const note = modificationData.modificationOrder?.modificationNote || '–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã';
			noteText.textContent = note;
		}

		function generateWhatsAppMessage() {
			const messageContainer = document.getElementById('whatsappMessage');
			
			if (!modificationData.modificationOrder) {
				messageContainer.textContent = '–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
				return;
			}

			const modOrder = modificationData.modificationOrder;
			const originalOrder = modificationData.originalOrder;
			const currentDate = new Date().toLocaleDateString("ru-RU");
			
			let message = `üìã –î–û–ü–û–õ–ù–ï–ù–ò–ï –ö –ó–ê–ö–ê–ó–£ –æ—Ç ${currentDate}\n\n`;
			
			// Reference to original order
			if (originalOrder) {
				const originalDate = new Date(originalOrder.timestamp).toLocaleDateString("ru-RU");
				message += `üîó –ö –∑–∞–∫–∞–∑—É –æ—Ç ${originalDate} (${originalOrder.departmentName})\n\n`;
			}
			
			// Added items
			message += `‚ûï –î–æ–±–∞–≤–ª—è–µ–º—ã–µ —Ç–æ–≤–∞—Ä—ã:\n`;
			message += `${modOrder.departmentName === '–ö—É—Ö–Ω—è' ? 'üç≥' : modOrder.departmentName === '–ë–∞—Ä' ? 'üç∑' : 'üßπ'} ${modOrder.departmentName}:\n`;
			
			if (modOrder.items && modOrder.items.length > 0) {
				modOrder.items.forEach(item => {
					message += `‚Ä¢ ${item.name} - ${item.quantity} ${item.unit}\n`;
				});
			}
			
			message += `\nüìù ${modOrder.modificationNote}\n`;
			message += `\nüìä –ò—Ç–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ: ${modOrder.totalItems} —Ç–æ–≤–∞—Ä–æ–≤`;

			messageContainer.textContent = message;
		}

		// Copy to clipboard functionality
		async function copyToClipboard() {
			const messageText = document.getElementById('whatsappMessage').textContent;
			const successMessage = document.getElementById('successMessage');
			const copyBtn = document.getElementById('copyBtn');

			try {
				await navigator.clipboard.writeText(messageText);
				
				// Show success message
				successMessage.classList.remove('hidden');
				
				// Update button temporarily
				const originalText = copyBtn.innerHTML;
				copyBtn.innerHTML = '<span>‚úÖ</span><span>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>';
				copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
				copyBtn.classList.add('bg-green-600', 'hover:bg-green-700');

				// Reset after 2 seconds
				setTimeout(() => {
					successMessage.classList.add('hidden');
					copyBtn.innerHTML = originalText;
					copyBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
					copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
				}, 2000);

			} catch (err) {
				console.error('Failed to copy text: ', err);
				// Fallback for older browsers
				const textArea = document.createElement('textarea');
				textArea.value = messageText;
				document.body.appendChild(textArea);
				textArea.select();
				document.execCommand('copy');
				document.body.removeChild(textArea);
				
				successMessage.classList.remove('hidden');
				setTimeout(() => {
					successMessage.classList.add('hidden');
				}, 2000);
			}
		}

		// Send to WhatsApp
		function sendToWhatsApp() {
			const messageText = document.getElementById('whatsappMessage').textContent;
			const encodedMessage = encodeURIComponent(messageText);
			
			// Detect if user is on mobile device
			const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
			
			// WhatsApp configuration (same as main confirmation page)
			const buyerPhone = "996708083303";
			let whatsappUrl;
			
			if (isMobile) {
				whatsappUrl = `whatsapp://send?phone=${buyerPhone}&text=${encodedMessage}`;
			} else {
				whatsappUrl = `https://web.whatsapp.com/send?phone=${buyerPhone}&text=${encodedMessage}`;
			}
			
			// Try to open WhatsApp
			const whatsappWindow = window.open(whatsappUrl, '_blank');
			
			// Fallback for mobile if WhatsApp app isn't installed
			if (isMobile && !whatsappWindow) {
				const fallbackUrl = `https://wa.me/${buyerPhone}?text=${encodedMessage}`;
				window.open(fallbackUrl, '_blank');
			}

			// Clear the pending modification from localStorage
			localStorage.removeItem('pendingModification');
			
			// Navigate to delivery page
			window.location.href = '/delivery';
		}

		function setupEventListeners() {
			// Back button
			document.getElementById('backBtn').addEventListener('click', () => {
				window.history.back();
			});

			// Copy button
			document.getElementById('copyBtn').addEventListener('click', copyToClipboard);

			// Send to WhatsApp button
			document.getElementById('sendWhatsAppBtn').addEventListener('click', sendToWhatsApp);

			// Go to delivery page button
			document.getElementById('deliveryPageBtn').addEventListener('click', () => {
				localStorage.removeItem('pendingModification');
				window.location.href = '/delivery';
			});

			// Cancel button
			document.getElementById('cancelBtn').addEventListener('click', () => {
				if (confirm('–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è? –ò–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
					localStorage.removeItem('pendingModification');
					window.history.back();
				}
			});
		}
	</script>
</Layout>
