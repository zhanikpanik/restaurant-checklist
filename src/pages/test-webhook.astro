---
// Test page for webhook
---

<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Test Webhook</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px;">
    <h1>üß™ Test External Order Webhook</h1>
    
    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h3>Webhook URL:</h3>
        <code id="webhookUrl" style="background: white; padding: 10px; display: block; border-radius: 4px;"></code>
    </div>
    
    <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h3>Test Form:</h3>
        <form id="testForm">
            <div style="margin: 10px 0;">
                <label>Department:</label><br/>
                <select id="department" style="width: 200px; padding: 5px;">
                    <option value="kitchen">Kitchen (–ö—É—Ö–Ω—è)</option>
                    <option value="bar">Bar (–ë–∞—Ä)</option>
                </select>
            </div>
            
            <div style="margin: 10px 0;">
                <label>Item Name:</label><br/>
                <input type="text" id="itemName" value="Test Item" style="width: 200px; padding: 5px;" />
            </div>
            
            <div style="margin: 10px 0;">
                <label>Quantity:</label><br/>
                <input type="number" id="quantity" value="1" style="width: 200px; padding: 5px;" />
            </div>
            
            <div style="margin: 10px 0;">
                <label>Unit:</label><br/>
                <input type="text" id="unit" value="—à—Ç" style="width: 200px; padding: 5px;" />
            </div>
            
            <button type="submit" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                üöÄ Send Test Order
            </button>
        </form>
    </div>
    
    <div id="result" style="margin: 20px 0; padding: 20px; border-radius: 8px; display: none;"></div>
    
    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h3>üìã Manual Test (cURL):</h3>
        <pre id="curlCommand" style="background: white; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 12px;"></pre>
    </div>

    <script>
        // Set the webhook URL based on current location
        const baseUrl = window.location.origin;
        const webhookUrl = `${baseUrl}/api/receive-external-order`;
        document.getElementById('webhookUrl').textContent = webhookUrl;
        
        // Update cURL command
        function updateCurlCommand() {
            const dept = document.getElementById('department').value;
            const name = document.getElementById('itemName').value;
            const qty = document.getElementById('quantity').value;
            const unit = document.getElementById('unit').value;
            
            const curlCmd = `curl -X POST "${webhookUrl}" \\
  -H "Content-Type: application/json" \\
  -d '{
    "department": "${dept}",
    "items": [
      {
        "name": "${name}",
        "quantity": ${qty},
        "unit": "${unit}"
      }
    ],
    "supplier": "Test Supplier"
  }'`;
            
            document.getElementById('curlCommand').textContent = curlCmd;
        }
        
        // Update cURL on load and form changes
        updateCurlCommand();
        document.getElementById('testForm').addEventListener('input', updateCurlCommand);
        
        // Handle form submission
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.style.background = '#f0f0f0';
            resultDiv.innerHTML = 'üîÑ Sending test order...';
            
            try {
                const dept = document.getElementById('department').value;
                const name = document.getElementById('itemName').value;
                const qty = parseFloat(document.getElementById('quantity').value);
                const unit = document.getElementById('unit').value;
                
                const orderData = {
                    department: dept,
                    items: [
                        {
                            name: name,
                            quantity: qty,
                            unit: unit
                        }
                    ],
                    supplier: "Test Supplier",
                    notes: "Test order from webhook test page"
                };
                
                console.log('Sending to:', webhookUrl);
                console.log('Order data:', orderData);
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
                
                const result = await response.json();
                console.log('Response:', result);
                
                if (result.success) {
                    resultDiv.style.background = '#d4edda';
                    resultDiv.innerHTML = `
                        <h4>‚úÖ Success!</h4>
                        <p><strong>Message:</strong> ${result.message}</p>
                        <p><strong>Next Steps:</strong></p>
                        <ol>
                            <li>Check the <a href="/delivery" target="_blank">/delivery page</a></li>
                            <li>Look for order with "Test Supplier" label</li>
                            <li>Execute the auto-save script below in console</li>
                        </ol>
                        <h5>Auto-Save Script:</h5>
                        <textarea readonly style="width: 100%; height: 120px; font-family: monospace; font-size: 11px;">${result.autoSaveScript}</textarea>
                    `;
                } else {
                    resultDiv.style.background = '#f8d7da';
                    resultDiv.innerHTML = `
                        <h4>‚ùå Error</h4>
                        <p><strong>Error:</strong> ${result.error}</p>
                        <p>Check the browser console for more details.</p>
                    `;
                }
                
            } catch (error) {
                console.error('Test failed:', error);
                resultDiv.style.background = '#f8d7da';
                resultDiv.innerHTML = `
                    <h4>‚ùå Network Error</h4>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p>Possible issues:</p>
                    <ul>
                        <li>Server not running</li>
                        <li>Wrong URL</li>
                        <li>CORS issues</li>
                        <li>Network connectivity</li>
                    </ul>
                `;
            }
        });
    </script>
</body>
</html>
