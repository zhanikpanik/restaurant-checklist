---
import Layout from "../layouts/Layout.astro";
---

<style>
    /* Native app styling */
    .native-card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.2s;
    }

    .native-card:active {
        transform: scale(0.98);
    }

    .status-badge {
        padding: 0.375rem 0.875rem;
        border-radius: 999px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .btn-native {
        border-radius: 12px;
        padding: 1rem 1.5rem;
        font-weight: 500;
        transition: all 0.2s;
        -webkit-tap-highlight-color: transparent;
    }

    .btn-native:active {
        transform: scale(0.97);
    }

    .btn-native-sm {
        border-radius: 10px;
        padding: 0.625rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s;
        -webkit-tap-highlight-color: transparent;
    }

    .btn-native-sm:active {
        transform: scale(0.97);
    }
</style>

<Layout title="Order Details - Restaurant System">
    <div class="min-h-screen bg-background">
        <!-- Native Mobile Header -->
        <div
            class="sticky top-0 z-40 bg-background/95 backdrop-blur-sm border-b"
        >
            <div class="flex items-center h-14 px-4">
                <a
                    href="/manager"
                    class="flex items-center justify-center w-10 h-10 -ml-2 rounded-full hover:bg-accent transition-colors"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 19l-7-7 7-7"></path>
                    </svg>
                </a>
                <h1 class="flex-1 text-lg font-semibold ml-2" id="orderTitle">
                    –ó–∞–≥—Ä—É–∑–∫–∞...
                </h1>
                <span id="orderStatus" class="status-badge">
                    <!-- Status will be populated -->
                </span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="px-4 py-4">
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div
                    class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"
                >
                </div>
                <p class="mt-4 text-muted-foreground">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–∞...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden text-center py-12">
                <div class="text-4xl mb-4">‚ùå</div>
                <h3 class="text-lg font-semibold mb-2">–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω</h3>
                <p class="text-muted-foreground mb-4">
                    –ó–∞–∫–∞–∑ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –±—ã–ª —É–¥–∞–ª–µ–Ω
                </p>
                <a
                    href="/manager"
                    class="inline-flex items-center btn-native bg-primary text-primary-foreground hover:bg-primary/90"
                >
                    ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–∫–∞–∑–∞–º
                </a>
            </div>

            <!-- Order Content -->
            <div id="orderContent" class="hidden space-y-3">
                <!-- Order Info Card -->
                <div class="native-card p-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-muted-foreground mb-1">
                                –í—Ä–µ–º—è –∑–∞–∫–∞–∑–∞
                            </div>
                            <div class="text-base font-semibold" id="orderTime">
                                -
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-muted-foreground mb-1">
                                –í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤
                            </div>
                            <div
                                class="text-base font-semibold"
                                id="orderTotalItems"
                            >
                                -
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories Section -->
                <div class="space-y-2">
                    <div id="categoryGroups">
                        <!-- Category groups will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Assign Supplier Modal -->
        <div
            id="assignSupplierModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
        >
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold">
                            –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
                        </h3>
                        <button
                            onclick="closeSupplierModal()"
                            class="text-gray-400 hover:text-gray-600">‚úï</button
                        >
                    </div>
                    <p
                        class="text-sm text-gray-600 mt-2"
                        id="supplierModalCategoryName"
                    >
                        –ö–∞—Ç–µ–≥–æ—Ä–∏—è: -
                    </p>
                </div>

                <div class="p-6 max-h-96 overflow-y-auto">
                    <div id="suppliersList">
                        <!-- Loading spinner -->
                        <div class="text-center py-8">
                            <div
                                class="animate-spin h-8 w-8 border-b-2 border-blue-600 rounded-full mx-auto mb-4"
                            >
                            </div>
                            <p class="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤...</p>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t">
                    <div class="flex space-x-3">
                        <button
                            onclick="assignSelectedSupplier()"
                            class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg"
                            id="assignSupplierBtn"
                            disabled
                        >
                            –ù–∞–∑–Ω–∞—á–∏—Ç—å
                        </button>
                        <button
                            onclick="closeSupplierModal()"
                            class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium rounded-lg"
                        >
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Missing Products Modal -->
        <div
            id="addMissingProductsModal"
            class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center"
        >
            <div
                class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] flex flex-col"
            >
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã
                        </h3>
                        <button
                            onclick="closeAddMissingProductsModal()"
                            class="text-gray-400 hover:text-gray-600">‚úï</button
                        >
                    </div>
                    <p class="text-sm text-gray-600 mt-2">
                        –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª –∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã –≤ –∑–∞–∫–∞–∑
                    </p>
                </div>

                <div class="p-6 flex-1 overflow-auto">
                    <!-- Section Tabs -->
                    <div class="mb-6">
                        <div class="flex border-b border-gray-200">
                            <button
                                onclick="loadMissingProductsSection('kitchen')"
                                class="section-btn flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-orange-600 hover:border-orange-300 transition-colors"
                            >
                                üç≥ –ö—É—Ö–Ω—è
                            </button>
                            <button
                                onclick="loadMissingProductsSection('bar')"
                                class="section-btn flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-purple-600 hover:border-purple-300 transition-colors"
                            >
                                üç∑ –ë–∞—Ä
                            </button>
                            <button
                                onclick="loadMissingProductsSection('custom')"
                                class="section-btn flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 transition-colors"
                            >
                                üßπ –ì–æ—Ä–Ω–∏—á–Ω–∞—è
                            </button>
                            <button
                                onclick="loadMissingProductsSection('other')"
                                class="section-btn flex-1 px-4 py-3 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-300 transition-colors"
                            >
                                üì¶ –î—Ä—É–≥–∏–µ
                            </button>
                        </div>
                    </div>

                    <!-- Search -->
                    <div class="mb-4">
                        <input
                            type="text"
                            id="missingProductsSearch"
                            placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            oninput="filterMissingProducts()"
                        />
                    </div>

                    <!-- Products List -->
                    <div
                        id="missingProductsList"
                        class="space-y-2 max-h-64 overflow-y-auto"
                    >
                        <div class="text-center text-gray-500 py-8">
                            <span class="text-4xl mb-2 block">üì¶</span>
                            <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–¥–µ–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤</p>
                        </div>
                    </div>
                </div>

                <div class="p-6 border-t">
                    <div class="flex space-x-3">
                        <button
                            onclick="addSelectedMissingProducts()"
                            class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg"
                            id="addMissingProductsSubmitBtn"
                            disabled
                        >
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                        </button>
                        <button
                            onclick="closeAddMissingProductsModal()"
                            class="flex-1 px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium rounded-lg"
                        >
                            –û—Ç–º–µ–Ω–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script is:inline>
        // Global variables
        let currentOrderData = null;
        let currentOrderDate = null;
        let currentMissingProductsSection = null;
        let allMissingProducts = [];
        let filteredMissingProducts = [];
        let selectedMissingProducts = {};

        // Supplier assignment variables
        let currentAssignCategoryId = null;
        let currentAssignCategoryName = null;
        let selectedSupplierId = null;
        let availableSuppliers = [];

        // Get order ID from URL parameters
        function getOrderIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get("orderId");
        }

        // Load order details
        async function loadOrderDetails() {
            const orderId = getOrderIdFromURL();
            if (!orderId) {
                showErrorState();
                return;
            }

            showLoadingState();

            try {
                const response = await fetch("/api/orders-by-category");
                const data = await response.json();

                if (data.success && data.data) {
                    // Find the order with the specific ID
                    const orderForId = data.data.find(
                        (order) =>
                            order.orderId.toString() === orderId.toString(),
                    );

                    if (orderForId) {
                        currentOrderData = orderForId;
                        currentOrderDate = orderForId.timestamp; // Keep for compatibility with missing products
                        displayOrderDetails(orderForId);
                        showOrderContent();
                    } else {
                        showErrorState();
                    }
                } else {
                    showErrorState();
                }
            } catch (error) {
                console.error("Error loading order details:", error);
                showErrorState();
            }
        }

        // Display order details
        function displayOrderDetails(orderData) {
            // Update title
            document.getElementById("orderTitle").textContent =
                `${orderData.departmentEmoji} #${orderData.orderId}`;

            // Update status
            const statusEl = document.getElementById("orderStatus");
            const statusColors = {
                pending: "bg-yellow-100 text-yellow-800",
                sent: "bg-blue-100 text-blue-800",
                delivered: "bg-green-100 text-green-800",
            };
            const statusText =
                orderData.status === "pending"
                    ? "–û–∂–∏–¥–∞–µ—Ç"
                    : orderData.status === "sent"
                      ? "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω"
                      : "–î–æ—Å—Ç–∞–≤–ª–µ–Ω";

            statusEl.textContent = statusText;
            statusEl.className = `status-badge ${statusColors[orderData.status] || "bg-gray-100 text-gray-800"}`;

            // Update order time and total items
            document.getElementById("orderTime").textContent =
                orderData.displayDate;
            document.getElementById("orderTotalItems").textContent =
                orderData.totalItems;

            // Display category groups
            displayCategoryGroups(orderData);
        }

        // Display category groups
        function displayCategoryGroups(orderData) {
            const container = document.getElementById("categoryGroups");

            let html = "";

            // Display each category separately
            orderData.categories.forEach((category) => {
                const hasSupplier = category.supplier && category.supplier.name;
                const supplierInfo = category.supplier || {};
                const hasPhone = hasSupplier && supplierInfo.phone;

                html += `
					<div class="native-card">
						<div class="p-4 space-y-3">
							<!-- Category Header -->
							<div class="flex items-start justify-between gap-2">
								<div class="flex-1 min-w-0">
									<h3 class="font-semibold text-base mb-1">üè∑Ô∏è ${category.categoryName}</h3>
									<div class="text-xs text-muted-foreground">
										${
                                            hasSupplier
                                                ? `
											üì¶ ${supplierInfo.name}${hasPhone ? ` ‚Ä¢ üì± ${supplierInfo.phone}` : ' ‚Ä¢ <span class="text-destructive">‚ö†Ô∏è –ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞</span>'}
										`
                                                : `
											<span class="text-destructive">‚ö†Ô∏è –ë–µ–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</span>
										`
                                        }
									</div>
								</div>
								<div class="text-xs text-muted-foreground bg-secondary px-2 py-1 rounded-full">
									${category.items.length} ${category.items.length === 1 ? "—Ç–æ–≤–∞—Ä" : category.items.length < 5 ? "—Ç–æ–≤–∞—Ä–∞" : "—Ç–æ–≤–∞—Ä–æ–≤"}
								</div>
							</div>

							<!-- Items -->
							<div class="space-y-1">
								${category.items
                                    .map(
                                        (item) => `
									<div class="flex justify-between items-center bg-secondary/50 rounded-lg px-3 py-2">
										<span class="text-sm truncate mr-2">${item.name}</span>
										<span class="text-sm font-medium whitespace-nowrap">${item.quantity} ${item.unit}</span>
									</div>
								`,
                                    )
                                    .join("")}
							</div>

							<!-- Action Buttons -->
							<div class="flex gap-2">
								${
                                    hasSupplier && hasPhone
                                        ? `
									<button
										onclick="sendSupplierOrder('${orderData.orderId}', [${category.categoryId}], '${supplierInfo.name}', ${supplierInfo.id})"
										class="flex-1 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-xl py-3 px-5 transition-all active:scale-95"
									>
										üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫—É
									</button>
								`
                                        : hasSupplier && !hasPhone
                                          ? `
									<button
										disabled
										class="flex-1 bg-secondary text-muted-foreground cursor-not-allowed text-sm font-medium rounded-xl py-3 px-5"
									>
										üì± –ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞
									</button>
								`
                                          : `
									<button
										onclick="assignSupplierToCategory(${category.categoryId}, '${category.categoryName}')"
										class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium rounded-xl py-3 px-5 transition-all active:scale-95"
									>
										–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞
									</button>
								`
                                }
							</div>
						</div>
					</div>
				`;
            });

            // Add missing products button after all categories
            html += `
				<div class="text-center pt-2">
					<button
						id="addMissingProductsBtn"
						onclick="openAddMissingProductsModal()"
						class="w-full bg-primary text-primary-foreground hover:bg-primary/90 font-medium rounded-xl py-4 px-6 transition-all active:scale-95"
					>
						‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã
					</button>
				</div>
			`;

            container.innerHTML = html;
        }

        // Send order to supplier
        async function sendSupplierOrder(
            orderId,
            categoryIds,
            supplierName,
            supplierId,
        ) {
            console.log(
                `üì§ Sending order to supplier: ${supplierName} for order: ${orderId}`,
            );

            try {
                if (!currentOrderData) {
                    throw new Error("Order data not loaded");
                }

                // Find all categories for this supplier
                const categories = currentOrderData.categories.filter((cat) =>
                    categoryIds.includes(cat.categoryId),
                );

                if (categories.length === 0) {
                    throw new Error("No categories found");
                }

                // Get supplier phone from first category
                const supplierPhone = categories[0].supplier?.phone;
                if (!supplierPhone) {
                    throw new Error("Supplier phone number not found");
                }

                // Generate consolidated WhatsApp message
                let message = `üìã –ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–æ–≤ - ${currentOrderData.displayDate}\n\n`;
                message += `üì¶ –ü–æ—Å—Ç–∞–≤—â–∏–∫: ${supplierName}\n\n`;

                categories.forEach((category) => {
                    message += `üè™ ${category.categoryName}:\n`;
                    category.items.forEach((item) => {
                        message += `‚Ä¢ ${item.name} - ${item.quantity} ${item.unit}\n`;
                    });
                    message += `\n`;
                });

                const totalItems = categories.reduce(
                    (sum, cat) => sum + cat.items.length,
                    0,
                );
                message += `üìä –ò—Ç–æ–≥–æ: ${totalItems} —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ ${categories.length} ${categories.length === 1 ? "–∫–∞—Ç–µ–≥–æ—Ä–∏–∏" : "–∫–∞—Ç–µ–≥–æ—Ä–∏–π"}`;

                // Send via WhatsApp
                const encodedMessage = encodeURIComponent(message);
                const isMobile =
                    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
                        navigator.userAgent,
                    );

                let whatsappUrl;
                if (isMobile) {
                    whatsappUrl = `whatsapp://send?phone=${supplierPhone}&text=${encodedMessage}`;
                } else {
                    whatsappUrl = `https://web.whatsapp.com/send?phone=${supplierPhone}&text=${encodedMessage}`;
                }

                // Try to open WhatsApp
                const whatsappWindow = window.open(whatsappUrl, "_blank");

                // If popup was blocked, show manual instructions
                if (
                    !whatsappWindow ||
                    whatsappWindow.closed ||
                    typeof whatsappWindow.closed === "undefined"
                ) {
                    const copyMessage = confirm(
                        "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å WhatsApp –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n\n" +
                            `–¢–µ–ª–µ—Ñ–æ–Ω: ${supplierPhone}\n\n` +
                            "–ù–∞–∂–º–∏—Ç–µ OK, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞.",
                    );

                    if (copyMessage) {
                        navigator.clipboard
                            .writeText(message)
                            .then(() => {
                                alert(
                                    `‚úÖ –¢–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!\n\n–û—Ç–∫—Ä–æ–π—Ç–µ WhatsApp –≤—Ä—É—á–Ω—É—é –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–∞ –Ω–æ–º–µ—Ä:\n${supplierPhone}`,
                                );
                            })
                            .catch(() => {
                                alert(
                                    `–¢–µ–ª–µ—Ñ–æ–Ω: ${supplierPhone}\n\n–¢–µ–∫—Å—Ç –∑–∞–∫–∞–∑–∞:\n\n${message}`,
                                );
                            });
                    }
                }

                // Update database for all categories
                const promises = categoryIds.map((categoryId) =>
                    fetch("/api/send-category-to-supplier", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            categoryId: categoryId,
                            supplierId: supplierId,
                        }),
                    }),
                );

                const responses = await Promise.all(promises);
                const results = await Promise.all(
                    responses.map((r) => r.json()),
                );

                const successCount = results.filter((r) => r.success).length;
                const failCount = results.filter((r) => !r.success).length;

                if (successCount > 0) {
                    alert(
                        `‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${successCount} ${successCount === 1 ? "–∫–∞—Ç–µ–≥–æ—Ä–∏—è" : "–∫–∞—Ç–µ–≥–æ—Ä–∏–π"} —á–µ—Ä–µ–∑ WhatsApp: ${supplierName}`,
                    );
                    loadOrderDetails(); // Refresh the display
                }

                if (failCount > 0) {
                    alert(
                        `‚ö†Ô∏è ${failCount} ${failCount === 1 ? "–∫–∞—Ç–µ–≥–æ—Ä–∏—é" : "–∫–∞—Ç–µ–≥–æ—Ä–∏–π"} –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –≤ –ë–î`,
                    );
                }
            } catch (error) {
                console.error("‚ùå Error sending order:", error);
                alert(
                    "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É: " + error.message,
                );
            }
        }

        // Assign supplier to category
        async function assignSupplierToCategory(categoryId, categoryName) {
            currentAssignCategoryId = categoryId;
            currentAssignCategoryName = categoryName;
            selectedSupplierId = null;

            // Open modal
            document
                .getElementById("assignSupplierModal")
                .classList.remove("hidden");
            document.getElementById("supplierModalCategoryName").textContent =
                `–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${categoryName}`;

            // Load suppliers
            await loadSuppliersForAssignment();
        }

        // Load suppliers for assignment
        async function loadSuppliersForAssignment() {
            const container = document.getElementById("suppliersList");

            container.innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin h-8 w-8 border-b-2 border-blue-600 rounded-full mx-auto mb-4"></div>
                    <p class="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤...</p>
                </div>
            `;

            try {
                const response = await fetch("/api/suppliers");
                const data = await response.json();

                if (data.success && data.data) {
                    availableSuppliers = data.data;
                    displaySuppliersList();
                } else {
                    throw new Error(data.error || "Failed to load suppliers");
                }
            } catch (error) {
                console.error("Error loading suppliers:", error);
                container.innerHTML = `
                    <div class="text-center py-8">
                        <span class="text-4xl mb-2 block">‚ùå</span>
                        <p class="text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</p>
                        <p class="text-sm text-gray-500">${error.message}</p>
                    </div>
                `;
            }
        }

        // Display suppliers list
        function displaySuppliersList() {
            const container = document.getElementById("suppliersList");

            if (availableSuppliers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <span class="text-4xl mb-2 block">üì≠</span>
                        <p class="text-gray-600">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</p>
                        <p class="text-sm text-gray-500 mt-2">–î–æ–±–∞–≤—å—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–µ–Ω–µ–¥–∂–µ—Ä"</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="space-y-2">';

            availableSuppliers.forEach((supplier) => {
                const hasPhone = supplier.phone && supplier.phone.trim() !== "";
                const isSelected = selectedSupplierId === supplier.id;

                html += `
                    <label class="flex items-start p-3 border rounded-lg cursor-pointer transition-all ${isSelected ? "bg-blue-50 border-blue-500" : "bg-gray-50 border-gray-200 hover:border-blue-300"}">
                        <input
                            type="radio"
                            name="supplier"
                            value="${supplier.id}"
                            ${isSelected ? "checked" : ""}
                            onchange="selectSupplierForAssignment(${supplier.id})"
                            class="mt-1 mr-3 h-4 w-4 text-blue-600"
                        >
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">${supplier.name}</div>
                            ${
                                hasPhone
                                    ? `
                                <div class="text-sm text-gray-600 mt-1">üì± ${supplier.phone}</div>
                            `
                                    : `
                                <div class="text-sm text-red-600 mt-1">‚ö†Ô∏è –ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
                            `
                            }
                            ${
                                supplier.contact_info
                                    ? `
                                <div class="text-xs text-gray-500 mt-1">${supplier.contact_info}</div>
                            `
                                    : ""
                            }
                        </div>
                    </label>
                `;
            });

            html += "</div>";
            container.innerHTML = html;
        }

        // Select supplier for assignment
        function selectSupplierForAssignment(supplierId) {
            console.log(
                "Selected supplier ID:",
                supplierId,
                "Type:",
                typeof supplierId,
            );
            selectedSupplierId = supplierId;

            // Enable assign button
            const btn = document.getElementById("assignSupplierBtn");
            btn.disabled = false;

            // Update visual selection
            displaySuppliersList();
        }

        // Assign selected supplier
        async function assignSelectedSupplier() {
            console.log("Attempting to assign:", {
                selectedSupplierId,
                currentAssignCategoryId,
                selectedSupplierIdType: typeof selectedSupplierId,
                currentAssignCategoryIdType: typeof currentAssignCategoryId,
            });

            if (!selectedSupplierId || !currentAssignCategoryId) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞");
                return;
            }

            const btn = document.getElementById("assignSupplierBtn");
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "‚è≥ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ...";

            try {
                const response = await fetch("/api/category-suppliers", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        categoryId: currentAssignCategoryId,
                        supplierId: selectedSupplierId,
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    const supplier = availableSuppliers.find(
                        (s) => s.id === selectedSupplierId,
                    );
                    alert(
                        `‚úÖ –ü–æ—Å—Ç–∞–≤—â–∏–∫ "${supplier.name}" —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${currentAssignCategoryName}"`,
                    );
                    closeSupplierModal();

                    // Reload order details to show updated supplier
                    await loadOrderDetails();
                } else {
                    throw new Error(data.error || "Failed to assign supplier");
                }
            } catch (error) {
                console.error("Error assigning supplier:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞: " + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Close supplier modal
        function closeSupplierModal() {
            document
                .getElementById("assignSupplierModal")
                .classList.add("hidden");
            currentAssignCategoryId = null;
            currentAssignCategoryName = null;
            selectedSupplierId = null;
            availableSuppliers = [];
        }

        // Edit supplier for categories
        function editSupplierForCategories(
            supplierId,
            supplierName,
            categoryIds,
        ) {
            alert(
                `–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ "${supplierName}" –¥–ª—è ${categoryIds.length} –∫–∞—Ç–µ–≥–æ—Ä–∏–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ.`,
            );
            // TODO: Implement bulk supplier editing modal
        }

        // Missing Products Modal Functions (similar to manager.astro)
        function openAddMissingProductsModal() {
            document
                .getElementById("addMissingProductsModal")
                .classList.remove("hidden");
            // Reset state
            currentMissingProductsSection = null;
            allMissingProducts = [];
            filteredMissingProducts = [];
            selectedMissingProducts = {};
            document.getElementById("missingProductsSearch").value = "";
            updateMissingProductsButton();

            // Reset section tabs
            document.querySelectorAll(".section-btn").forEach((btn) => {
                btn.classList.remove("text-green-600", "border-green-500");
                btn.classList.add("text-gray-500", "border-transparent");
            });
        }

        function closeAddMissingProductsModal() {
            document
                .getElementById("addMissingProductsModal")
                .classList.add("hidden");
        }

        async function loadMissingProductsSection(section) {
            currentMissingProductsSection = section;

            // Update tab states
            document.querySelectorAll(".section-btn").forEach((btn) => {
                btn.classList.remove("text-green-600", "border-green-500");
                btn.classList.add("text-gray-500", "border-transparent");
            });
            event.target.classList.remove(
                "text-gray-500",
                "border-transparent",
            );
            event.target.classList.add("text-green-600", "border-green-500");

            const container = document.getElementById("missingProductsList");
            container.innerHTML = `
				<div class="text-center text-gray-500 py-8">
					<div class="animate-spin h-8 w-8 border-b-2 border-green-600 rounded-full mx-auto mb-4"></div>
					<p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...</p>
				</div>
			`;

            try {
                let apiUrl = "";
                switch (section) {
                    case "kitchen":
                        apiUrl = "/api/kitchen-inventory";
                        break;
                    case "bar":
                        apiUrl = "/api/bar-inventory";
                        break;
                    case "custom":
                        apiUrl = "/api/combined-inventory?department=–ì–æ—Ä–Ω–∏—á–Ω–∞—è";
                        break;
                    case "other":
                        apiUrl = "/api/custom-products";
                        break;
                }

                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.success) {
                    allMissingProducts = data.data || [];
                    filteredMissingProducts = [...allMissingProducts];
                    displayMissingProducts();
                } else {
                    throw new Error(data.error || "Failed to load products");
                }
            } catch (error) {
                console.error("Error loading missing products:", error);
                container.innerHTML = `
					<div class="text-center text-red-500 py-8">
						<span class="text-4xl mb-2 block">‚ùå</span>
						<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤</p>
						<p class="text-sm text-gray-500">${error.message}</p>
					</div>
				`;
            }
        }

        function displayMissingProducts() {
            const container = document.getElementById("missingProductsList");

            if (filteredMissingProducts.length === 0) {
                container.innerHTML = `
					<div class="text-center text-gray-500 py-8">
						<span class="text-4xl mb-2 block">üîç</span>
						<p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
					</div>
				`;
                return;
            }

            let html = "";
            filteredMissingProducts.forEach((product) => {
                const productId = product.id || product.product_id;
                const productName =
                    product.name || product.product_name || product.title;
                const productUnit = product.unit || "—à—Ç";
                const isSelected = selectedMissingProducts[productId];

                html += `
					<div class="flex items-center justify-between p-3 border rounded-lg ${isSelected ? "bg-green-50 border-green-300" : "bg-gray-50 border-gray-200"}">
						<div class="flex items-center flex-1">
							<input
								type="checkbox"
								id="missing-product-${productId}"
								${isSelected ? "checked" : ""}
								onchange="toggleMissingProduct(${productId}, '${productName}', '${productUnit}')"
								class="mr-3 h-4 w-4 text-green-600 rounded focus:ring-green-500"
							>
							<div>
								<label for="missing-product-${productId}" class="font-medium text-gray-900 cursor-pointer">
									${productName}
								</label>
								<div class="text-sm text-gray-500">${productUnit}</div>
							</div>
						</div>
						${
                            isSelected
                                ? `
							<div class="flex items-center space-x-2">
								<input
									type="number"
									value="${selectedMissingProducts[productId].quantity}"
									min="0.1"
									step="0.1"
									class="w-20 px-2 py-1 border border-green-300 rounded text-sm focus:outline-none focus:ring-1 focus:ring-green-500"
									onchange="updateMissingProductQuantity(${productId}, this.value)"
								>
								<span class="text-sm text-gray-600">${productUnit}</span>
							</div>
						`
                                : ""
                        }
					</div>
				`;
            });

            container.innerHTML = html;
        }

        function toggleMissingProduct(productId, productName, unit) {
            if (selectedMissingProducts[productId]) {
                delete selectedMissingProducts[productId];
            } else {
                selectedMissingProducts[productId] = {
                    id: productId,
                    name: productName,
                    unit: unit,
                    quantity: 1,
                    section: currentMissingProductsSection,
                };
            }

            displayMissingProducts();
            updateMissingProductsButton();
        }

        function updateMissingProductQuantity(productId, quantity) {
            if (selectedMissingProducts[productId]) {
                selectedMissingProducts[productId].quantity =
                    parseFloat(quantity) || 1;
            }
        }

        function filterMissingProducts() {
            const searchTerm = document
                .getElementById("missingProductsSearch")
                .value.toLowerCase();

            if (!searchTerm) {
                filteredMissingProducts = [...allMissingProducts];
            } else {
                filteredMissingProducts = allMissingProducts.filter(
                    (product) => {
                        const productName =
                            product.name ||
                            product.product_name ||
                            product.title ||
                            "";
                        return productName.toLowerCase().includes(searchTerm);
                    },
                );
            }

            displayMissingProducts();
        }

        function updateMissingProductsButton() {
            const btn = document.getElementById("addMissingProductsSubmitBtn");
            const selectedCount = Object.keys(selectedMissingProducts).length;

            if (selectedCount > 0) {
                btn.disabled = false;
                btn.textContent = `‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${selectedCount})`;
            } else {
                btn.disabled = true;
                btn.textContent = "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ";
            }
        }

        async function addSelectedMissingProducts() {
            const selectedCount = Object.keys(selectedMissingProducts).length;
            if (selectedCount === 0) return;

            const btn = document.getElementById("addMissingProductsSubmitBtn");
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = "‚è≥ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ...";

            try {
                // Create order items from selected products
                const orderItems = Object.values(selectedMissingProducts).map(
                    (product) => ({
                        name: product.name,
                        quantity: product.quantity,
                        unit: product.unit,
                    }),
                );

                // Create a new order with these items for the specific date
                const orderData = {
                    department: currentMissingProductsSection || "manager",
                    items: orderItems,
                    status: "pending",
                    created_by: "manager",
                    created_at: new Date(currentOrderDate).toISOString(),
                };

                const response = await fetch("/api/orders", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(orderData),
                });

                const data = await response.json();

                if (data.success) {
                    alert(
                        `–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${selectedCount} —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑!`,
                    );
                    closeAddMissingProductsModal();
                    // Refresh order details
                    loadOrderDetails();
                } else {
                    throw new Error(data.error || "Failed to add products");
                }
            } catch (error) {
                console.error("Error adding missing products:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤: " + error.message);
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // UI State Functions
        function showLoadingState() {
            document.getElementById("loadingState").classList.remove("hidden");
            document.getElementById("errorState").classList.add("hidden");
            document.getElementById("orderContent").classList.add("hidden");
        }

        function showErrorState() {
            document.getElementById("loadingState").classList.add("hidden");
            document.getElementById("errorState").classList.remove("hidden");
            document.getElementById("orderContent").classList.add("hidden");
        }

        function showOrderContent() {
            document.getElementById("loadingState").classList.add("hidden");
            document.getElementById("errorState").classList.add("hidden");
            document.getElementById("orderContent").classList.remove("hidden");
        }

        // Initialize page
        document.addEventListener("DOMContentLoaded", function () {
            loadOrderDetails();
        });
    </script>
</Layout>
