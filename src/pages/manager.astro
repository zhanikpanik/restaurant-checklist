---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Менеджер - Панель управления">
	<div class="min-h-screen bg-background">
		<!-- Navbar -->
		<div class="border-b sticky top-0 z-50 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
			<div class="container flex h-14 items-center justify-between mx-auto px-4">
				<div class="flex items-center gap-2">
					<span class="text-2xl">👔</span>
					<span class="text-xl font-bold">Менеджер</span>
				</div>
				<a href="/" class="text-sm text-muted-foreground hover:text-foreground">
					← Назад
				</a>
			</div>
		</div>

		<!-- Main Content -->
		<main class="container mx-auto p-4">
			<!-- Tabs -->
			<div class="mb-6">
				<div class="border-b">
					<nav class="flex gap-4 -mb-px">
						<button class="tab-active border-b-2 border-primary px-4 py-2 text-sm font-medium">
							📋 Заказы
						</button>
						<button class="px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground">
							✅ Доставлено
						</button>
						<button class="px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground">
							🏷️ Категории
						</button>
						<button class="px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground">
							🏢 Поставщики
						</button>
						<button class="px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground">
							🏪 Отделы
						</button>
						<button class="px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground">
							📦 Товары
						</button>
						<button class="px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground">
							⚙️ Настройки
						</button>
					</nav>
				</div>
			</div>

			<!-- Orders Tab Content -->
			<div>
				<h3 class="text-2xl font-bold mb-4">📋 Заказы по категориям</h3>
				<div id="ordersByCategory">
					<div class="text-center text-muted-foreground py-12">
						<div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
						<p class="mt-4">Загрузка заказов...</p>
					</div>
				</div>
			</div>
		</main>
	</div>

	<script>
		import OrderCard from '../lib/components/OrderCard.svelte';

		// Load orders by category
		async function loadOrdersByCategory() {
			console.log('📋 Loading orders by category...');
			try {
				const response = await fetch('/api/orders-by-category');
				const data = await response.json();

				if (data.success) {
					displayOrdersByCategory(data.data);
				} else {
					console.error('❌ Failed to load orders:', data.error);
					displayOrdersByCategory([]);
				}
			} catch (error) {
				console.error('❌ Error loading orders:', error);
				displayOrdersByCategory([]);
			}
		}

		// Display orders using Svelte components
		function displayOrdersByCategory(orders: any[]) {
			const container = document.getElementById('ordersByCategory');
			if (!container) return;

			if (!orders || orders.length === 0) {
				container.innerHTML = `
					<div class="text-center py-12">
						<div class="text-6xl mb-4">📋</div>
						<p class="text-xl font-semibold mb-2">Нет заказов</p>
						<p class="text-muted-foreground">Заказы появятся здесь после создания</p>
					</div>
				`;
				return;
			}

			// Clear container
			container.innerHTML = '';

			// Create container for cards
			const cardsContainer = document.createElement('div');
			cardsContainer.className = 'space-y-4';
			container.appendChild(cardsContainer);

			// Create Svelte component for each order
			orders.forEach((order: any) => {
				const target = document.createElement('div');
				cardsContainer.appendChild(target);

				new OrderCard({
					target,
					props: { order }
				});
			});
		}

		// Load data on page load
		document.addEventListener('DOMContentLoaded', () => {
			console.log('📱 Manager page loaded with shadcn-svelte');
			loadOrdersByCategory();
			setInterval(loadOrdersByCategory, 30000);
		});
	</script>
</Layout>
